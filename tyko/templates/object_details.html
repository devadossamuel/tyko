{% extends "details_table.html" %}
{% from "_macros.html" import notes_table_row, note_editor_events, notes_table, metadata_table%}
{% from "_details_macros.html" import add_field_row, confirm_remove_entity_modal, child_entity_row, remove_modal_event_scripts, metadata_text_edit_widget, metadata_select_edit_widget, metadata_select_dynamic_edit_widget, metadata_date_edit_widget%}
{% from "_item_macros.html" import item_new_button_row, new_item_modal %}

{%- block detail_table %}
    <nav class="navbar navbar-expand-lg  navbar-light justify-content-start bg-light">
        <div class="mx-1">
            <a href="{{ url_for('object_pbcore', id=object['object_id']) }}" download>PBCore</a>
        </div>
    </nav>
    <div class="card my-1">
        <div class="card-body">
            {% call metadata_table() %}
                <tr>{{metadata_text_edit_widget("Name", object['name'], 'name', api_path)}}</tr>
                <tr>
                    {% with %}
                        {%  call metadata_select_dynamic_edit_widget("Collection", object['collection_name'], callback_name="callback", field_key="collection_id", update_api_path=api_path) %}
                                function callback(options){
                                    requests.get("{{url_for('collection')}}")
                                        .then((result)=>{
                                            let collections = [];
                                            JSON.parse(result)['collections'].forEach((collection)=>{
                                                options.push(
                                                    {
                                                        value: collection['collection_id'],
                                                        text: collection['collection_name']
                                                    }
                                                )
                                            });
                                        }).catch((reason) => {
                                         throw  "Failed to get collections data"
                                        });
                                    }
                        {% endcall %}
                    {% endwith %}
                </tr>
                <tr>{{metadata_text_edit_widget("Barcode", object['barcode'], 'barcode', api_path)}}</tr>
                <tr>{{metadata_date_edit_widget("Originals Received Date", object['originals_rec_date'], "originals_rec_date", api_path)}}</tr>
                <tr>{{metadata_date_edit_widget("Originals Returned Date", object['originals_return_date'], "originals_return_date", api_path)}}</tr>
            {% endcall %}
        </div>
    </div>
    <div class="card my-1">
        <div class="card-header">
            <h5 class="card-title">Items</h5>
        </div>
        <div class="card-body">
            <table class="table">
                <caption hidden>Items</caption>
                <thead>
                    <th scope="col" hidden>Items</th>
                    <th scope="col" hidden>Remove</th>
                </thead>
                {% if "project_id" in object %}
                    <tbody>
                        {% for item in object['items'] %}
                            {{ child_entity_row(
                                item['name'],
                                url_for('page_project_object_item_details', project_id=object['project_id'], object_id=object['object_id'], item_id=item['item_id']),
                                "removeItemModal",
                                url_for("object_item", project_id=object['project_id'], object_id=object['object_id'], item_id=item['item_id'])
                                ) }}
                        {%- endfor -%}
                        {{
                                item_new_button_row(
                                    url_for("project_object_add_item", object_id=object['object_id'], project_id=object['project_id']),
                                    "newItemtModal"
                                )
                        }}
                    </tbody>
                {% endif %}
            </table>
        </div>
        {% if "project_id" in object %}
            {{ new_item_modal("newItemtModal", formats, url_for("project_object_add_item", object_id=object['object_id'], project_id=object['project_id'])) }}
        {% endif %}
        {{ confirm_remove_entity_modal("removeItemModal") }}
    </div>
    <div class="card">
        <h5 class="card-header">Notes</h5>
        <div class="card-body">
            {% call(note) notes_table(object['notes'], api_path) %}
                {{notes_table_row(note, url_for("object_notes", project_id=object['project_id'], object_id=object['object_id'], note_id=note['note_id']) )}}
            {% endcall %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    {{ remove_modal_event_scripts("removeItemModal") }}
    {% if "project_id" in object %}
        {{ note_editor_events(url_for('project_object', project_id=object['project_id'], object_id=object['object_id']), valid_note_types) }}
    {% endif %}
{% endblock %}